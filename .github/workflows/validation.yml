name: XML Validation

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches: [ master ]
    paths-ignore: [ '**.md' ]
  pull_request:
    branches: [ master ]
    paths-ignore: [ '**.md' ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "XML"

#  xml-linter:
#    runs-on: ubuntu-latest
#
#    steps:
#    - name: Checkout repo
#      uses: actions/checkout@v2
#
#    - name: Enable problem matcher
#      uses: korelstar/xmllint-problem-matcher@v1
#
#    - name: Download XSD schema files
#      run: |
#        wget https://raw.githubusercontent.com/Cockatrice/Cockatrice/master/doc/carddatabase_v3/cards.xsd -O carddb-v3.xsd
#        wget https://raw.githubusercontent.com/Cockatrice/Cockatrice/master/doc/carddatabase_v4/cards.xsd -O carddb-v4.xsd
#
#    - name: Lint tokens.xml
#      uses: ChristophWurst/xmllint-action@v1
#      with:
#        xml-file: ./tokens.xml
#        xml-schema-file: ./carddb-v4.xsd
#
#    - name: Lint challenge_tokens.xml
#      uses: ChristophWurst/xmllint-action@v1
#      with:
#        xml-file: ./challenge_tokens.xml
#        xml-schema-file: ./carddb-v3.xsd

  build:
    name: 'xmllint'
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
     # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout repo
        uses: actions/checkout@v3

    # Runs a set of commands using the runners shell
      - name: Install dependencies
        run: sudo apt-get install libxml2-utils

      - name: Enable problem matcher
        uses: korelstar/xmllint-problem-matcher@v1

      - name: Download XSD metaschema
        if: always()
        id: meta
        run: |
          wget https://www.w3.org/2012/04/XMLSchema.xsd

      - name: Download and validate XSD schema for card database v4
        if: always()
        id: dl_v4
        run: |
          wget https://raw.githubusercontent.com/Cockatrice/Cockatrice/master/doc/carddatabase_v4/cards.xsd -O carddb_v4.xsd
          xmllint --noout --schema XMLSchema.xsd carddb_v4.xsd

      - name: Download and validate XSD schema for card database v3
        if: always()
        id: dl_v3
        run: |
          wget https://raw.githubusercontent.com/Cockatrice/Cockatrice/master/doc/carddatabase_v3/cards.xsd -O carddb_v3.xsd
          xmllint --noout --schema XMLSchema.xsd carddb_v3.xsd

      - name: Validate XML files (v4)
        if: steps.dl_v4.outcome == 'success'
        run: |
          xmllint --noout --schema carddb_v4.xsd tokens.xml

      - name: Validate XML files (v3)
        if: steps.dl_v3.outcome == 'success'
        run: |
          xmllint --noout --schema carddb_v3.xsd challenge_tokens.xml
