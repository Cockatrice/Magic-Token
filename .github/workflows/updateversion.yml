name: Update version on pr approval

on:
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

jobs:
  update_version:
    if: >
      ( github.event_name == 'pull_request_review' &&
        github.event.review.state == 'approved' &&
        ( github.event.review.author_association == 'OWNER' ||
          github.event.review.author_association == 'MEMBER'
        ) &&
        ! contains( github.event.review.body, '@github-actions noop' )
      ) ||
      ( github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        ( github.event.comment.author_association == 'OWNER' ||
          github.event.comment.author_association == 'MEMBER'
        ) &&
        endsWith( github.event.comment.body, '@github-actions update version' )
      )
    runs-on: ubuntu-latest
    steps:
      - name: Get proper pr info
        id: configure
        env:
          EVENT: ${{github.event_name}}
          REPO: ${{github.repository}}
          PR_NO: ${{github.event.issue.number}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
          REPO_URL: ${{github.event.pull_request.head.repo.clone_url}}
          REPO_PAGE: ${{github.event.pull_request.head.repo.svn_url}}
          REF: ${{github.event.pull_request.head.ref}}
          SHA: ${{github.event.pull_request.head.sha}}
        run: |
          if [[ $EVENT == "issue_comment" ]]; then
            tmp="$(mktemp)"
            gh pr view "$PR_NO" --repo "$REPO" --json >"$tmp"
            <$tmp
            SHA="$(jq ".head.repo.sha" "$tmp")"
            REPO_URL="$(jq ".head.repo.clone_url" "$tmp")"
            REPO_PAGE="$(jq ".head.repo.svn_url" "$tmp")"
            REF="$(jq ".head.repo.ref" "$tmp")"
          fi
          echo "::set-output name=sha::$SHA"
          echo "::set-output name=url::$REPO_URL"
          echo "::set-output name=page::$REPO_PAGE"
          echo "::set-output name=ref::$REF"

      - name: Checkout pull request
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          ref: ${{steps.configure.outputs.sha}}

      - name: Update date
        shell: bash
        env:
          REPO_URL: ${{steps.configure.outputs.url}}
          REPO_PAGE: ${{steps.configure.outputs.page}}
          REF: ${{steps.configure.outputs.ref}}
        run: .github/workflows/updateversion.sh
